---
import { Icon } from 'astro-icon/components';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class:list={["h-full flex flex-col bg-white dark:bg-gray-800 rounded-2xl p-6 md:p-8 shadow-2xl", className]}>
  <!-- Trust Elements -->
  <div class="flex items-center justify-between mb-6 pb-6 border-b border-gray-100 dark:border-gray-700">
    <div class="flex items-center space-x-4">
      <div class="flex items-center p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
        <Icon name="heroicons:shield-check" class="h-6 w-6 text-green-600 dark:text-green-400" />
      </div>
      <div class="flex items-center p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
        <Icon name="heroicons:document-check" class="h-6 w-6 text-blue-600 dark:text-blue-400" />
      </div>
    </div>
    <div class="text-xs text-gray-500 dark:text-gray-400 text-right">
      <p>SSL verschlüsselt</p>
      <p>DSGVO-konform</p>
    </div>
  </div>

  <form id="simpleContactForm" class="h-full flex flex-col" method="POST" action="/api/contact" data-netlify="true" data-netlify-honeypot="bot-field">
    <div class="flex-grow space-y-6">
      <!-- Basic Info -->
      <div id="formErrors" class="hidden bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 p-4 rounded-lg mb-4">
        <div class="flex items-center gap-2">
          <Icon name="heroicons:exclamation-circle" class="w-5 h-5" />
          <p class="text-sm font-medium">Bitte korrigieren Sie die folgenden Fehler:</p>
        </div>
        <ul class="list-disc list-inside mt-2 text-sm"></ul>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2 sm:col-span-1">
          <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name *</label>
          <input
            type="text"
            id="name"
            name="name"
            required
            class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            placeholder="Ihr vollständiger Name"
          />
        </div>
        <div class="col-span-2 sm:col-span-1">
          <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">E-Mail *</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            placeholder="ihre@email.de"
          />
        </div>
      </div>

      <!-- Message -->
      <div>
        <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ihre Nachricht *</label>
        <textarea
          id="message"
          name="message"
          rows="4"
          required
          class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          placeholder="Wie können wir Ihnen helfen?"
        ></textarea>
      </div>

      <!-- Quote Link -->
      <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4">
        <p class="text-sm text-gray-600 dark:text-gray-300">
          Benötigen Sie einen detaillierten Kostenvoranschlag?
          <a href="/kostenvoranschlag/" class="text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-500 font-medium">
            Nutzen Sie unser ausführliches Kostenvoranschlag Formular →
          </a>
        </p>
      </div>

      <!-- Privacy Policy -->
      <div class="flex items-start space-x-3">
        <div class="flex items-center h-5">
          <input
            id="privacy"
            name="privacy"
            type="checkbox"
            required
            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-primary-600 focus:ring-primary-500"
          />
        </div>
        <label for="privacy" class="text-sm text-gray-500 dark:text-gray-400">
          Ich stimme der <a href="/datenschutz/" class="text-primary-600 hover:text-primary-700 underline">Datenschutzerklärung</a> zu *
        </label>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="mt-6">
      <button
        type="submit"
        class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
      >
        Nachricht senden
        <Icon name="heroicons:paper-airplane" class="ml-2 -mr-1 h-5 w-5" />
      </button>
      <p class="mt-3 text-xs text-center text-gray-500 dark:text-gray-400">
        <Icon name="heroicons:shield-check" class="inline-block w-4 h-4 mr-1 text-primary-600" />
        Ihre Daten werden SSL-verschlüsselt übertragen
      </p>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById('simpleContactForm') as HTMLFormElement | null;

  type NotificationType = 'success' | 'error';

  const showNotification = (type: NotificationType, text: string) => {
    const existingNotification = document.querySelector('[data-form-notification="simple"]');
    existingNotification?.remove();

    const notification = document.createElement('div');
    notification.dataset.formNotification = 'simple';
    notification.className = [
      'fixed top-4 right-4 z-50 px-4 py-3 rounded border shadow-lg transition-opacity',
      type === 'success'
        ? 'bg-green-100 dark:bg-green-900 border-green-400 dark:border-green-700 text-green-700 dark:text-green-300'
        : 'bg-red-100 dark:bg-red-900 border-red-400 dark:border-red-700 text-red-700 dark:text-red-300'
    ].join(' ');
    notification.setAttribute('role', 'status');
    notification.setAttribute('aria-live', 'polite');

    const content = document.createElement('div');
    content.className = 'flex items-center';

    const icon = document.createElement('span');
    icon.className = 'mr-2 text-lg font-semibold';
    icon.setAttribute('aria-hidden', 'true');
    icon.textContent = type === 'success' ? '✓' : '!';

    const srLabel = document.createElement('span');
    srLabel.className = 'sr-only';
    srLabel.textContent = type === 'success' ? 'Erfolgsmeldung:' : 'Fehlermeldung:';

    const message = document.createElement('p');
    message.textContent = text;

    content.append(icon, srLabel, message);
    notification.appendChild(content);

    document.body.appendChild(notification);
    window.setTimeout(() => notification.remove(), 5000);
  };

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();

    const formData = new FormData(event.target as HTMLFormElement);

    const errorContainer = document.getElementById('formErrors');
    const errorList = errorContainer?.querySelector('ul');
    if (errorList) errorList.innerHTML = '';
    errorContainer?.classList.add('hidden');

    const errors: string[] = [];
    const name = (formData.get('name') ?? '').toString().trim();
    const email = (formData.get('email') ?? '').toString().trim();
    const message = (formData.get('message') ?? '').toString().trim();
    const privacy = formData.get('privacy');

    if (!name) errors.push('Name ist erforderlich');
    if (!email) errors.push('E-Mail ist erforderlich');
    if (!message) errors.push('Nachricht ist erforderlich');
    if (!privacy) errors.push('Bitte stimmen Sie der Datenschutzerklärung zu');

    if (errors.length > 0) {
      if (errorContainer && errorList) {
        errorContainer.classList.remove('hidden');
        errors.forEach((error) => {
          const li = document.createElement('li');
          li.textContent = error;
          errorList.appendChild(li);
        });
      }
      return;
    }

    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    submitButton?.setAttribute('aria-busy', 'true');
    submitButton?.setAttribute('disabled', 'true');

    try {
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(Object.fromEntries(formData.entries()))
      });

      if (response.ok) {
        showNotification('success', 'Vielen Dank für Ihre Nachricht. Wir melden uns in Kürze bei Ihnen.');
        form?.reset();
      } else {
        const errorText = await response.text();
        throw new Error(errorText || 'Fehler beim Senden der Nachricht');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showNotification('error', 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.');
    } finally {
      submitButton?.removeAttribute('aria-busy');
      submitButton?.removeAttribute('disabled');
    }
  });
</script>
